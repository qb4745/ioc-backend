# Frontend Sync Brief: API del Backend (v2025-09-21)

## 1. Resumen Ejecutivo
Este documento es la especificación oficial de la API del backend, generada desde el código fuente (controladores y DTOs). Sirve como contrato de integración para que el equipo de Frontend consuma los endpoints de forma segura y consistente.

## 2. Política de Autenticación
- Mecanismo: Todos los endpoints protegidos requieren un JWT en la cabecera `Authorization: Bearer <token>`.
- Errores: Las peticiones sin token válido a endpoints protegidos devolverán `401 Unauthorized` o `403 Forbidden`.

---

## 3. API Endpoints Disponibles

### Endpoint: [POST] /api/etl/start-process
- Descripción: Inicia un proceso ETL para el archivo CSV subido. Valida, calcula hash para idempotencia, crea el job y dispara el procesamiento asíncrono.
- Protegido: Sí (requiere estar autenticado; `@PreAuthorize("isAuthenticated()")`).
- Consumes: `multipart/form-data` (parte `file` como CSV)
- Produces: `application/json`
- Cabeceras requeridas:
  - `Authorization: Bearer <token>`
- Parámetros de petición:
  - Path Variables: N/A
  - Query Params: N/A
  - Multipart (form-data):
    - `file`: binary (CSV) – requerido. Tamaño máximo permitido 50MB. Extensión esperada `.csv`. Content-Type aceptados: `text/csv`, `application/csv`, `text/plain`.
- Contrato de Petición (Request Body):
  ```typescript
  // N/A (se envía como multipart/form-data con una parte llamada "file")
  ```
- Contrato de Respuesta (202 Accepted):
  ```typescript
  interface StartProcessResponse {
    jobId: string;     // UUID
    fileName: string;  // nombre de archivo original
    status: string;    // "INICIADO"
  }
  ```
- Códigos de estado adicionales:
  - 202 Accepted: Proceso aceptado y disparado en background (respuesta mostrada arriba).
  - 400 Bad Request: Archivo vacío, tamaño > 50MB, extensión inválida o Content-Type inválido.
  - 409 Conflict: El archivo ya fue procesado previamente (idempotencia por hash).
  - 429 Too Many Requests: Rate limit.
  - 401/403: Autenticación/autorización inválida.
  - 5xx: Error interno inesperado.
- Rate Limiting:
  - Cabeceras devueltas: `RateLimit-Limit`, `RateLimit-Remaining`, `RateLimit-Reset`, `Retry-After` (RFC 9331).
- Ejemplo curl:
  ```bash
  curl -X POST "http://<host>/api/etl/start-process" \
    -H "Authorization: Bearer <token>" \
    -H "Accept: application/json" \
    -F "file=@/ruta/al/archivo.csv;type=text/csv"
  ```

---

### Endpoint: [GET] /api/etl/jobs/{jobId}/status
- Descripción: Recupera el estado del job ETL.
- Protegido: Sí (requiere estar autenticado; `@PreAuthorize("isAuthenticated()")`).
- Consumes: `*/*`
- Produces: `application/json`
- Cabeceras requeridas:
  - `Authorization: Bearer <token>`
- Parámetros de petición:
  - Path Variables:
    - `{jobId}`: `string` (UUID) – requerido.
  - Query Params: N/A
- Contrato de Petición (Request Body):
  ```typescript
  // N/A
  ```
- Contrato de Respuesta (200 OK):
  ```typescript
  interface EtlJobStatusDto {
    jobId: string;             // UUID
    fileName: string;
    status: string;            // e.g., "INICIADO", "EXITO", "FALLO"
    details: string | null;    // detalles adicionales si aplica
    minDate: string | null;    // LocalDate ISO: YYYY-MM-DD
    maxDate: string | null;    // LocalDate ISO: YYYY-MM-DD
    createdAt: string | null;  // OffsetDateTime ISO: e.g., 2025-09-21T12:34:56Z
    finishedAt: string | null; // OffsetDateTime ISO
  }
  ```
- Códigos de estado adicionales:
  - 404 Not Found: Job no encontrado.
  - 429 Too Many Requests: Rate limit.
  - 401/403: Autenticación/autorización inválida.
- Rate Limiting:
  - Cabeceras devueltas: `RateLimit-Limit`, `RateLimit-Remaining`, `RateLimit-Reset`, `Retry-After` (RFC 9331).
- Ejemplo curl:
  ```bash
  curl -X GET "http://<host>/api/etl/jobs/<job-uuid>/status" \
    -H "Authorization: Bearer <token>" \
    -H "Accept: application/json"
  ```

---

## 4. Referencia de DTOs (TypeScript)
```typescript
// Respuesta del POST /api/etl/start-process (202 Accepted)
export interface StartProcessResponse {
  jobId: string;     // UUID
  fileName: string;  // nombre de archivo original
  status: string;    // "INICIADO"
}

// Respuesta del GET /api/etl/jobs/{jobId}/status (200 OK)
export interface EtlJobStatusDto {
  jobId: string;             // UUID
  fileName: string;
  status: string;            // e.g., "INICIADO", "EXITO", "FALLO"
  details: string | null;    // detalles adicionales si aplica
  minDate: string | null;    // LocalDate ISO: YYYY-MM-DD
  maxDate: string | null;    // LocalDate ISO: YYYY-MM-DD
  createdAt: string | null;  // OffsetDateTime ISO (Z o con offset)
  finishedAt: string | null; // OffsetDateTime ISO
}
```

## 5. Formato y Convenciones
- Fechas como strings ISO-8601:
  - `LocalDate` -> `YYYY-MM-DD`
  - `OffsetDateTime` -> `YYYY-MM-DDTHH:mm:ss[.SSS]Z` o con offset
- Enums -> unir como string literal union (no aplica en los DTOs actuales).
- Nullabilidad: Campos opcionales o nulos en Java se representan como `T | null`.
- Colecciones: `List<T>`/`Set<T>` -> `T[]`.

## 6. Resumen y Próximos Pasos
- Backend: estos endpoints están implementados en el código de producción (EtlController) y protegidos por JWT; el rate limiting aplica a la ruta `/api/etl/**`.
- Frontend: usar este documento como fuente de verdad para la integración. Para subidas, enviar el archivo como `multipart/form-data` en la parte `file`.
- Si se detectan nuevas rutas o DTOs, regenerar este brief.

