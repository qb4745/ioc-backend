# Contexto de negocio - FP-001A (Plantilla para completar)
# Rellena los valores reales para que se puedan incorporar al System Prompt y al feature

company:
  name: "Cambiaso"
  legal_name: "Cambiaso S.A."  # opcional
  industry: "Manufactura"      # ej: Alimentos, Empaque, Industrial
  description: ""            # breve descripci√≥n del negocio (1-2 l√≠neas)

products:
  # Lista de SKUs importantes y su descripci√≥n/objetivo
  - sku: 45001
    name: "Caja Grande"
    description: "Caja para empaque final, 50x50"
    objetivo_share_percent: 40    # % objetivo del mix de producci√≥n mensual
    unidad: "cajas"
  - sku: 45002
    name: "Caja Peque√±a"
    description: "Caja peque√±a para muestras"
    objetivo_share_percent: 20
    unidad: "cajas"

metrics:
  unidad_cantidad: "piezas"            # ¬øqu√© significa `cantidad` en BD?
  peso_unit: "kg"
  objetivo_mensual_unidades: 150000     # objetivo global por mes (ejemplo)
  objetivo_diario_por_operario: 500     # objetivo por operario por d√≠a
  objetivo_eficiencia_turno_dia_percent: 70

shifts:
  dia:
    name: "D√≠a"
    start: "06:00"
    end: "18:00"
    expectation: "Mayor productividad"
  noche:
    name: "Noche"
    start: "18:00"
    end: "06:00"
    expectation: "70% del turno diurno"

workdays:
  types:
    - name: "Normal"
      impact: "Sin recargo"
    - name: "Extra"
      impact: "Pago extra, m√°s productividad"
    - name: "Festivo"
      impact: "Menor personal, mayor costo"
  max_range_months_in_prompt: 12

machines:
  types:
    - code: "ENVASADORA"
      description: "M√°quina principal de envasado"
    - code: "SELLADORA"
      description: "M√°quina de sellado"
  critical_machines:
    - codigo_maquina: "MAQ-001"
      nombre_maquina: "Envasadora Principal"
      notes: "Alta carga, candidato a mantenimiento preventivo prioritario"
    - codigo_maquina: "MAQ-003"
      nombre_maquina: "Empacadora Secundaria"
      notes: "Backup, uso variable"

operators:
  id_fields:
    - "maquinista_fk"
    - "codigo_maquinista"
  anonymize_names: false   # true -> anonimizamos nombres al enviar a Gemini
  anonymization_policy: "Si true, reemplazar nombre_completo por Operario #N"

dashboards:
  default_period: "last_month"   # valores posibles: last_month, last_30_days, custom
  permitted_filters:
    - centro_costos
    - turno
    - maquina_id
    - material_sku
  per_dashboard_metadata:
    "5":   # dashboardId: ejemplo 5 (Producci√≥n por Operario)
      title: "Producci√≥n por Operario - Mensual"
      type: "OPERACIONAL"
      description: "Analiza producci√≥n por operario y por m√°quina"
      graphs:
        - id: "grafico_1"
          title: "Top 10 Operarios por Unidades"
          type: "bar_chart"
          suggested_query: "-- VER TEMPLATE: usar Query 2 del Feature Plan para top operarios"
        - id: "grafico_2"
          title: "Tendencia Diaria de Producci√≥n"
          type: "line_chart"
          suggested_query: "-- VER TEMPLATE: usar Query 5 del Feature Plan"

data_quality:
  null_values_policy: "COALESCE nombres o marcar como 'Sin asignar' para maquinista"
  outlier_detection_thresholds:
    production_spike_pct: 50    # si un d√≠a > +50% vs promedio diario -> considerar pico
    low_activity_days: 3       # si operario tiene 0 registros en √∫ltimos X d√≠as -> alerta

security:
  pii_fields:
    - nombre_completo
    - usuario_sap
  send_pii_to_gemini: false    # si false, anonimizar antes de enviar
  audit_log_required: true
  audit_fields:
    - userId
    - dashboardId
    - fechaInicio
    - fechaFin
    - tokensUsados
    - fromCache
    - durationMs

integration_notes:
  metabase_api: false   # Para Alternativa A NO usamos Metabase API; backend ejecuta queries
  reason: "Evitar dependencias y respetar same-origin; usamos queries en backend"
  gemini_api_usage: "Generar texto (Markdown) a partir de datos agregados"

gemini_prompt_guidelines:
  system_description: |
    Eres un analista de datos que explica dashboards de producci√≥n para Cambiaso.
    Utiliza los nombres de columnas y las m√©tricas proporcionadas.
    Responde en espa√±ol. No inventes valores.
  max_input_tokens: 2000
  max_response_tokens: 500
  required_output_structure: |
    # üìä RESUMEN EJECUTIVO
    [2-3 l√≠neas]

    # üîë KEY POINTS
    ‚Ä¢ [punto 1]
    ‚Ä¢ [punto 2]

    # ‚ö° INSIGHTS ACCIONABLES
    ‚Ä¢ [insight 1]

few_shot_examples:
  - example_name: "Operario l√≠der - ejemplo"
    input_summary: |
      Totales: produccion_total=145320, peso_total_kg=32340, total_operarios=18
      Top operario: Carlos Gonz√°lez, 15234 unidades en 23 d√≠as
    expected_output_snippet: |
      # üìä RESUMEN EJECUTIVO
      En junio 2025 se produjeron 145,320 unidades... (2-3 l√≠neas)

      # üîë KEY POINTS
      ‚Ä¢ Carlos Gonz√°lez lidera con 15,234 unidades (10.5% del total)

      # ‚ö° INSIGHTS ACCIONABLES
      ‚Ä¢ Revisar MAQ-001 por alta carga; considerar mantenimiento preventivo.

operational_policies:
  cache_ttl_minutes: 5
  rate_limit_per_user_per_minute: 5
  max_query_range_months: 12

contacts:
  product_owner:
    name: ""
    email: ""
  tech_lead:
    name: ""
    email: ""

notes:
  - "Rellenar todos los campos marcados como ejemplo antes de implementaci√≥n"
  - "Si `send_pii_to_gemini` es true, marcar raz√≥n y obtener aprobaci√≥n legal"

data_model:
  fact_production:
    table: public.fact_production
    description: "Tabla de hechos: un registro por evento de producci√≥n (p. ej. pallet/registro)"
    primary_key: id
    natural_key: [fecha_contabilizacion, maquina_fk, "COALESCE(maquinista_fk,0)", numero_log]
    indexes:
      - name: idx_fact_production_fecha
        columns: [fecha_contabilizacion]
      - name: uq_fact_prod_natural
        unique: true
        columns: [fecha_contabilizacion, maquina_fk, "COALESCE(maquinista_fk,0)", numero_log]
    columns:
      fecha_contabilizacion:
        type: date
        required: true
        description: "Fecha del registro de producci√≥n (granularidad: d√≠a). Usada para filtros de per√≠odo y series temporales."
        usage: ["filter","group_by","time_series"]
      id:
        type: bigserial
        required: true
        description: "Primary key (surrogate)."
      bodeguero:
        type: character varying(100)
        required: false
        description: "Nombre del bodeguero/operador de almac√©n (opcional)."
        pii: true
      cantidad:
        type: numeric(18,4)
        required: true
        description: "Unidades producidas por registro. Interprete seg√∫n `metrics.unidad_cantidad`."
        aggregation: SUM
        usage: ["production_total","avg_per_day","top_operarios"]
      centro_costos:
        type: bigint
        required: false
        description: "Centro de costos contable (opcional)."
      documento:
        type: bigint
        required: false
        description: "Referencia de documento/orden (opcional)."
      fecha_notificacion:
        type: date
        required: true
        description: "Fecha de notificaci√≥n del registro (puede coincidir con fecha_contabilizacion)."
      hora_contabilizacion:
        type: time without time zone
        required: true
        description: "Hora en que se contabiliz√≥ el registro."
      jornada:
        type: character varying(10)
        required: false
        description: "Tipo de jornada (Normal/Extra/Festivo)."
      lista:
        type: character varying(10)
        required: false
        description: "Campo auxiliar/etiqueta del proceso."
      material_descripcion:
        type: character varying(255)
        required: false
        description: "Descripci√≥n textual del material/SKU."
      material_sku:
        type: bigint
        required: true
        description: "SKU num√©rico del material producido. Vincular con cat√°logo de productos."
      numero_log:
        type: bigint
        required: true
        description: "N√∫mero de log/orden de producci√≥n; junto a fecha, m√°quina y maquinista define unicidad natural."
      numero_pallet:
        type: integer
        required: false
        description: "Identificador del pallet (si aplica)."
      peso_neto:
        type: numeric(18,4)
        required: true
        description: "Peso neto total del registro (kg)."
        aggregation: SUM
      turno:
        type: character varying(10)
        required: true
        description: "Turno en que se produjo (p. ej. 'D√≠a', 'Noche'). Usado para distribuci√≥n por turno."
      usuario_sap:
        type: character varying(100)
        required: false
        description: "Usuario SAP que registr√≥ la operaci√≥n (opcional)."
        pii: true
      version_produccion:
        type: character varying(50)
        required: false
        description: "Versi√≥n del proceso/linea de producci√≥n."
      maquina_fk:
        type: bigint
        required: true
        description: "FK a dim_maquina.id - m√°quina que produjo el registro."
        fk: "dim_maquina.id"
      maquinista_fk:
        type: bigint
        required: false
        description: "FK a dim_maquinista.id - operario que realiz√≥ la operaci√≥n (nullable)."
        fk: "dim_maquinista.id"
      status_origen:
        type: character varying(10)
        required: false
        description: "Origen o estado del registro (sistema origen)."

  dim_maquinista:
    table: public.dim_maquinista
    description: "Dimensi√≥n de operarios (maquinistas)."
    primary_key: id
    columns:
      id:
        type: bigint
        description: "PK (identity)."
      codigo_maquinista:
        type: bigint
        description: "C√≥digo √∫nico del operario."
      nombre_completo:
        type: character varying(255)
        description: "Nombre completo del operario. (PII)"
        pii: true
      created_at:
        type: timestamp with time zone
        description: "Audit: creaci√≥n del registro."
      updated_at:
        type: timestamp with time zone
        description: "Audit: √∫ltima actualizaci√≥n."

  dim_maquina:
    table: public.dim_maquina
    description: "Dimensi√≥n de m√°quinas."
    primary_key: id
    columns:
      id:
        type: bigint
        description: "PK (identity)."
      codigo_maquina:
        type: character varying(255)
        description: "C√≥digo √∫nico de la m√°quina (ej: 'MAQ-001')."
      nombre_maquina:
        type: character varying(255)
        description: "Nombre descriptivo de la m√°quina."
      created_at:
        type: timestamp with time zone
        description: "Audit: creaci√≥n del registro."
      updated_at:
        type: timestamp with time zone
        description: "Audit: √∫ltima actualizaci√≥n."

  foreign_keys:
    - column: maquinista_fk
      references: public.dim_maquinista.id
    - column: maquina_fk
      references: public.dim_maquina.id

aggregations_for_prompts:
  description: "Plantillas SQL agregadas que el backend puede ejecutar para construir el prompt enviado a Gemini. Reemplazar :fechaInicio/:fechaFin y otros binds seg√∫n sea necesario."
  total_summary: |
    SELECT
      COUNT(DISTINCT maquinista_fk) AS total_operarios,
      COUNT(DISTINCT maquina_fk) AS total_maquinas,
      SUM(cantidad) AS produccion_total,
      SUM(peso_neto) AS peso_total_kg,
      MIN(fecha_contabilizacion) AS fecha_inicio,
      MAX(fecha_contabilizacion) AS fecha_fin
    FROM public.fact_production fp
    WHERE fp.fecha_contabilizacion BETWEEN :fechaInicio AND :fechaFin;

  top_operarios: |
    SELECT
      dm.codigo_maquinista,
      dm.nombre_completo,
      COUNT(DISTINCT fp.fecha_contabilizacion) as dias_trabajados,
      SUM(fp.cantidad) as total_unidades,
      ROUND(SUM(fp.cantidad)::numeric / NULLIF(COUNT(DISTINCT fp.fecha_contabilizacion),0),2) as promedio_unidades_por_dia,
      STRING_AGG(DISTINCT dmaq.nombre_maquina, ', ') as maquinas_utilizadas
    FROM public.fact_production fp
    LEFT JOIN public.dim_maquinista dm ON fp.maquinista_fk = dm.id
    LEFT JOIN public.dim_maquina dmaq ON fp.maquina_fk = dmaq.id
    WHERE fp.fecha_contabilizacion BETWEEN :fechaInicio AND :fechaFin
    GROUP BY dm.id, dm.codigo_maquinista, dm.nombre_completo
    ORDER BY total_unidades DESC
    LIMIT 10;

  distribution_by_shift: |
    SELECT turno, SUM(cantidad) AS unidades, COUNT(DISTINCT maquinista_fk) AS operarios
    FROM public.fact_production
    WHERE fecha_contabilizacion BETWEEN :fechaInicio AND :fechaFin
    GROUP BY turno;

  top_machines: |
    SELECT dmaq.codigo_maquina, dmaq.nombre_maquina, SUM(fp.cantidad) as total_unidades
    FROM public.fact_production fp
    JOIN public.dim_maquina dmaq ON fp.maquina_fk = dmaq.id
    WHERE fp.fecha_contabilizacion BETWEEN :fechaInicio AND :fechaFin
    GROUP BY dmaq.id, dmaq.codigo_maquina, dmaq.nombre_maquina
    ORDER BY total_unidades DESC
    LIMIT 5;

  daily_trend: |
    SELECT fecha_contabilizacion, SUM(cantidad) as produccion_dia
    FROM public.fact_production
    WHERE fecha_contabilizacion BETWEEN :fechaInicio AND :fechaFin
    GROUP BY fecha_contabilizacion
    ORDER BY fecha_contabilizacion;

recommended_prompt_fields:
  - fecha_contabilizacion
  - cantidad
  - peso_neto
  - maquina_fk
  - maquinista_fk
  - turno
  - material_sku
  - material_descripcion
  - numero_pallet
  - numero_log
