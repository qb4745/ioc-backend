


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MetabaseEmbeddingService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.cambiaso.ioc.service</a>
</div>

<h1>Coverage Summary for Class: MetabaseEmbeddingService (com.cambiaso.ioc.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MetabaseEmbeddingService</td>
<td class="coverageStat">
  <span class="percent">
    27.3%
  </span>
  <span class="absValue">
    (3/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    11.8%
  </span>
  <span class="absValue">
    (4/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    17.8%
  </span>
  <span class="absValue">
    (13/73)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MetabaseEmbeddingService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    27.3%
  </span>
  <span class="absValue">
    (3/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    11.8%
  </span>
  <span class="absValue">
    (4/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    17.8%
  </span>
  <span class="absValue">
    (13/73)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.cambiaso.ioc.service;
&nbsp;
&nbsp;import com.cambiaso.ioc.config.MetabaseProperties;
&nbsp;import com.cambiaso.ioc.exception.DashboardAccessDeniedException;
&nbsp;import com.cambiaso.ioc.exception.DashboardNotFoundException;
&nbsp;import com.cambiaso.ioc.security.CustomUserDetails;
&nbsp;import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
&nbsp;import io.jsonwebtoken.Jwts;
&nbsp;import io.jsonwebtoken.security.Keys;
&nbsp;import io.micrometer.core.instrument.MeterRegistry;
&nbsp;import io.micrometer.core.instrument.Timer;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.cache.annotation.Cacheable;
&nbsp;import org.springframework.security.core.Authentication;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import javax.crypto.SecretKey;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.Date;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Map;
&nbsp;import java.util.concurrent.TimeUnit;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;public class MetabaseEmbeddingService {
&nbsp;
&nbsp;    private final MetabaseProperties properties;
&nbsp;    private final SecretKey key;
&nbsp;    private final DashboardAuditService auditService;
&nbsp;    private final MeterRegistry meterRegistry;
&nbsp;
&nbsp;    public MetabaseEmbeddingService(
&nbsp;            MetabaseProperties properties,
&nbsp;            DashboardAuditService auditService,
&nbsp;            MeterRegistry meterRegistry
<b class="fc">&nbsp;    ) {</b>
<b class="fc">&nbsp;        this.properties = properties;</b>
<b class="fc">&nbsp;        this.auditService = auditService;</b>
<b class="fc">&nbsp;        this.meterRegistry = meterRegistry;</b>
&nbsp;        
<b class="fc">&nbsp;        validateSecretKey(properties.getSecretKey());</b>
&nbsp;        
<b class="fc">&nbsp;        this.key = Keys.hmacShaKeyFor(</b>
<b class="fc">&nbsp;            properties.getSecretKey().getBytes(StandardCharsets.UTF_8)</b>
&nbsp;        );
&nbsp;        
<b class="fc">&nbsp;        log.info(&quot;MetabaseEmbeddingService initialized successfully with {} configured dashboards&quot;, </b>
<b class="fc">&nbsp;            properties.getDashboards().size());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void validateSecretKey(String secretKey) {
<b class="pc">&nbsp;        if (secretKey == null || secretKey.isBlank()) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(</b>
&nbsp;                &quot;Metabase secret key is required. Set METABASE_SECRET_KEY environment variable.&quot;
&nbsp;            );
&nbsp;        }
<b class="pc">&nbsp;        if (secretKey.length() &lt; 64) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(</b>
<b class="nc">&nbsp;                String.format(&quot;Metabase secret key is too short (%d chars). Must be at least 64 characters.&quot;, </b>
<b class="nc">&nbsp;                    secretKey.length())</b>
&nbsp;            );
&nbsp;        }
<b class="pc">&nbsp;        if (!secretKey.matches(&quot;^[A-Fa-f0-9]+$&quot;)) {</b>
<b class="nc">&nbsp;            throw new IllegalStateException(</b>
&nbsp;                &quot;Metabase secret key must be hexadecimal (0-9, A-F). Check your METABASE_SECRET_KEY variable.&quot;
&nbsp;            );
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @CircuitBreaker(name = &quot;metabaseService&quot;, fallbackMethod = &quot;getSignedDashboardUrlFallback&quot;)
&nbsp;    @Cacheable(value = &quot;dashboardTokens&quot;, key = &quot;#authentication.name + &#39;_&#39; + #dashboardId&quot;)
&nbsp;    public String getSignedDashboardUrl(int dashboardId, Authentication authentication) {
<b class="nc">&nbsp;        Timer.Sample sample = Timer.start(meterRegistry);</b>
&nbsp;        
&nbsp;        try {
<b class="nc">&nbsp;            MetabaseProperties.DashboardConfig config = findDashboardConfig(dashboardId);</b>
<b class="nc">&nbsp;            checkAuthorization(config, authentication);</b>
&nbsp;            
<b class="nc">&nbsp;            auditService.logDashboardAccess(authentication.getName(), dashboardId, config.getName(), true);</b>
&nbsp;            
<b class="nc">&nbsp;            Map&lt;String, Object&gt; params = buildParams(config, authentication);</b>
<b class="nc">&nbsp;            String token = generateToken(dashboardId, params);</b>
<b class="nc">&nbsp;            String url = String.format(&quot;%s/embed/dashboard/%s#bordered=true&amp;titled=true&quot;, </b>
<b class="nc">&nbsp;                properties.getSiteUrl(), token);</b>
&nbsp;            
<b class="nc">&nbsp;            meterRegistry.counter(&quot;metabase.dashboard.access&quot;, &quot;dashboard&quot;, String.valueOf(dashboardId), &quot;user&quot;, authentication.getName(), &quot;status&quot;, &quot;success&quot;).increment();</b>
<b class="nc">&nbsp;            log.debug(&quot;Generated signed URL for dashboard {} for user {}&quot;, dashboardId, authentication.getName());</b>
&nbsp;            
<b class="nc">&nbsp;            return url;</b>
&nbsp;            
&nbsp;        } catch (DashboardAccessDeniedException | DashboardNotFoundException e) {
<b class="nc">&nbsp;            String username = (authentication != null &amp;&amp; authentication.getName() != null) ? authentication.getName() : &quot;unknown&quot;;</b>
<b class="nc">&nbsp;            auditService.logDashboardAccess(username, dashboardId, &quot;UNKNOWN&quot;, false);</b>
<b class="nc">&nbsp;            meterRegistry.counter(&quot;metabase.dashboard.access&quot;, &quot;dashboard&quot;, String.valueOf(dashboardId), &quot;user&quot;, username, &quot;status&quot;, &quot;denied&quot;).increment();</b>
&nbsp;            throw e;
&nbsp;        } finally {
<b class="nc">&nbsp;            sample.stop(Timer.builder(&quot;metabase.dashboard.request.duration&quot;).tag(&quot;dashboard&quot;, String.valueOf(dashboardId)).register(meterRegistry));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unused&quot;)
&nbsp;    private String getSignedDashboardUrlFallback(int dashboardId, Authentication authentication, Exception ex) {
<b class="nc">&nbsp;        log.error(&quot;Circuit breaker activated for dashboard {}. Metabase may be down.&quot;, dashboardId, ex);</b>
<b class="nc">&nbsp;        meterRegistry.counter(&quot;metabase.dashboard.access&quot;, &quot;dashboard&quot;, String.valueOf(dashboardId), &quot;user&quot;, authentication.getName(), &quot;status&quot;, &quot;circuit_open&quot;).increment();</b>
<b class="nc">&nbsp;        throw new RuntimeException(&quot;Dashboard service is temporarily unavailable. Please try again in a few moments.&quot;, ex);</b>
&nbsp;    }
&nbsp;
&nbsp;    private MetabaseProperties.DashboardConfig findDashboardConfig(int dashboardId) {
<b class="nc">&nbsp;        return properties.getDashboards().stream()</b>
<b class="nc">&nbsp;            .filter(d -&gt; d.getId() == dashboardId)</b>
<b class="nc">&nbsp;            .findFirst()</b>
<b class="nc">&nbsp;            .orElseThrow(() -&gt; new DashboardNotFoundException(String.format(&quot;Dashboard with ID %d is not configured or does not exist.&quot;, dashboardId)));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void checkAuthorization(MetabaseProperties.DashboardConfig config, Authentication authentication) {
&nbsp;        // --- LÓGICA DE AUTORIZACIÓN TEMPORAL (PERMITE A CUALQUIER AUTENTICADO) ---
&nbsp;        // Se verifica únicamente que el usuario esté autenticado.
<b class="nc">&nbsp;        if (authentication == null || !authentication.isAuthenticated()) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Unauthenticated user attempted to access dashboard {}&quot;, config.getName());</b>
<b class="nc">&nbsp;            throw new DashboardAccessDeniedException(&quot;You must be authenticated to view this dashboard.&quot;);</b>
&nbsp;        }
&nbsp;
&nbsp;        /*
&nbsp;        // --- LÓGICA DE AUTORIZACIÓN BASADA EN ROLES (DESACTIVADA TEMPORALMENTE) ---
&nbsp;        // TODO: Reactivar esta sección cuando los roles se gestionen y se incluyan en el JWT.
&nbsp;        boolean isAuthorized = authentication.getAuthorities().stream()
&nbsp;            .anyMatch(grantedAuthority -&gt; config.getAllowedRoles().contains(grantedAuthority.getAuthority()));
&nbsp;        
&nbsp;        if (!isAuthorized) {
&nbsp;            log.warn(&quot;User {} attempted to access dashboard {} without proper roles. Required: {}, Has: {}&quot;, 
&nbsp;                authentication.getName(), config.getName(), config.getAllowedRoles(), authentication.getAuthorities());
&nbsp;            throw new DashboardAccessDeniedException(String.format(&quot;You do not have permission to view &#39;%s&#39;. Required roles: %s&quot;, config.getName(), config.getAllowedRoles()));
&nbsp;        }
&nbsp;        */
&nbsp;    }
&nbsp;
&nbsp;    private Map&lt;String, Object&gt; buildParams(MetabaseProperties.DashboardConfig config, Authentication authentication) {
<b class="nc">&nbsp;        Map&lt;String, Object&gt; params = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        if (config.getFilters() == null || config.getFilters().isEmpty()) return params;</b>
&nbsp;        
<b class="nc">&nbsp;        if (!(authentication.getPrincipal() instanceof CustomUserDetails userDetails)) {</b>
<b class="nc">&nbsp;            log.warn(&quot;Authentication principal is not CustomUserDetails. Attribute-based filters will not be applied.&quot;);</b>
<b class="nc">&nbsp;            return params;</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        config.getFilters().forEach(filter -&gt; {</b>
<b class="nc">&nbsp;            if (&quot;USER_ATTRIBUTE&quot;.equals(filter.getType())) {</b>
<b class="nc">&nbsp;                Object value = extractUserAttribute(userDetails, filter.getSource());</b>
<b class="nc">&nbsp;                if (value != null) {</b>
<b class="nc">&nbsp;                    params.put(filter.getName(), value);</b>
<b class="nc">&nbsp;                    log.debug(&quot;Applied filter: {} = {}&quot;, filter.getName(), value);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    log.warn(&quot;Could not extract user attribute &#39;{}&#39; for filter &#39;{}&#39;&quot;, filter.getSource(), filter.getName());</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
<b class="nc">&nbsp;        return params;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Object extractUserAttribute(CustomUserDetails userDetails, String attributeName) {
<b class="nc">&nbsp;        return switch (attributeName) {</b>
<b class="nc">&nbsp;            case &quot;userId&quot; -&gt; userDetails.getUserId();</b>
<b class="nc">&nbsp;            case &quot;username&quot; -&gt; userDetails.getUsername();</b>
<b class="nc">&nbsp;            case &quot;email&quot; -&gt; userDetails.getEmail();</b>
<b class="nc">&nbsp;            case &quot;department&quot; -&gt; userDetails.getDepartment();</b>
<b class="nc">&nbsp;            case &quot;region&quot; -&gt; userDetails.getRegion();</b>
<b class="nc">&nbsp;            case &quot;fullName&quot; -&gt; userDetails.getFullName();</b>
&nbsp;            default -&gt; {
<b class="nc">&nbsp;                log.warn(&quot;Unknown user attribute requested: {}&quot;, attributeName);</b>
<b class="nc">&nbsp;                yield null;</b>
&nbsp;            }
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private String generateToken(int dashboardId, Map&lt;String, Object&gt; params) {
<b class="nc">&nbsp;        long expirationMillis = TimeUnit.MINUTES.toMillis(properties.getTokenExpirationMinutes());</b>
&nbsp;        
<b class="nc">&nbsp;        return Jwts.builder()</b>
<b class="nc">&nbsp;            .claim(&quot;resource&quot;, Map.of(&quot;dashboard&quot;, dashboardId))</b>
<b class="nc">&nbsp;            .claim(&quot;params&quot;, params)</b>
<b class="nc">&nbsp;            .setExpiration(new Date(System.currentTimeMillis() + expirationMillis))</b>
<b class="nc">&nbsp;            .setIssuedAt(new Date())</b>
<b class="nc">&nbsp;            .signWith(key, Jwts.SIG.HS256)  // CRÍTICO: Metabase requiere HS256, no HS512</b>
<b class="nc">&nbsp;            .compact();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-10-22 07:08</div>
</div>
</body>
</html>
