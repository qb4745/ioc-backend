# ===================================================================
# BASE CONFIGURATION - SHARED BY ALL PROFILES
# ===================================================================
# This file contains ONLY common settings shared across all environments.
# Environment-specific values go in application-{profile}.properties

# Application Info
spring.application.name=ioc-backend

# Default profile for local development
spring.profiles.active=local

# ===================================================================
# SUPABASE AUTH - Common Settings
# ===================================================================
# These values are environment-specific and must be set via environment variables
# supabase.url=${SUPABASE_URL}
# supabase.service-role-key=${SUPABASE_SERVICE_ROLE_KEY}

# ===================================================================
# DATABASE - Common Settings
# ===================================================================
# Explicit PostgreSQL driver (prevents H2 auto-detection)
spring.datasource.driver-class-name=org.postgresql.Driver

# ===================================================================
# JPA/Hibernate - Common Settings
# ===================================================================
spring.jpa.open-in-view=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.properties.hibernate.jdbc.batch_size=20
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true
spring.jpa.properties.hibernate.generate_statistics=false

# Physical naming strategy (keep camelCase)
spring.jpa.hibernate.naming.physical-strategy=org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

# ===================================================================
# ACTUATOR - Common Settings
# ===================================================================
management.endpoints.web.exposure.include=health,metrics,prometheus,info
management.endpoint.health.show-details=when-authorized
management.metrics.tags.application=${spring.application.name}

# ===================================================================
# CACHE - Common Settings
# ===================================================================
spring.cache.type=caffeine
spring.cache.caffeine.spec=maximumSize=10000,expireAfterWrite=9m

# ===================================================================
# SPRING AI - Google GenAI Configuration
# ===================================================================
# Enable Google GenAI Chat Model
spring.ai.model.chat=google-genai

# API Key (set via environment variable)
spring.ai.google.genai.api-key=${GEMINI_API_KEY}

# Model configuration - Using 2.0-flash-exp to avoid thinking latency
# gemini-2.0-flash-exp: No thinking mode, faster streaming, lower latency
# gemini-2.5-flash: Has thinking mode enabled by default (higher latency)
# spring.ai.google.genai.chat.options.model=gemini-2.0-flash-exp
spring.ai.google.genai.chat.options.model=gemini-flash-lite-latest
spring.ai.google.genai.chat.options.temperature=0.2
spring.ai.google.genai.chat.options.max-output-tokens=8192
spring.ai.google.genai.chat.options.top-p=0.95
spring.ai.google.genai.chat.options.top-k=40

# ===================================================================
# FILE UPLOAD - Common Settings
# ===================================================================
spring.servlet.multipart.max-file-size=50MB
spring.servlet.multipart.max-request-size=50MB

# ===================================================================
# RESILIENCE4J - Common Settings
# ===================================================================
resilience4j.circuitbreaker.instances.notification-service.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.notification-service.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.notification-service.sliding-window-size=10
resilience4j.circuitbreaker.instances.notification-service.minimum-number-of-calls=5

resilience4j.circuitbreaker.instances.metabaseService.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.metabaseService.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.instances.metabaseService.sliding-window-size=10
resilience4j.circuitbreaker.instances.metabaseService.permitted-number-of-calls-in-half-open-state=3

resilience4j.ratelimiter.instances.dashboardAccess.limit-for-period=10
resilience4j.ratelimiter.instances.dashboardAccess.limit-refresh-period=60s
resilience4j.ratelimiter.instances.dashboardAccess.timeout-duration=0s

# AI Explanation Rate Limiting (MVP: 5 requests per minute)
resilience4j.ratelimiter.instances.aiExplanation.limit-for-period=5
resilience4j.ratelimiter.instances.aiExplanation.limit-refresh-period=60s
resilience4j.ratelimiter.instances.aiExplanation.timeout-duration=0s

# ===================================================================
# ETL - Common Settings
# ===================================================================
etl.lock.enabled=false
etl.duplicate.check.enabled=true
etl.duplicate.fail-on-detect=false
etl.duplicate.check.sample-limit=10
etl.retry.unique.enabled=true
etl.retry.unique.max-attempts=5
etl.unique.enforced=false
etl.jobs.stuck.threshold-minutes=30

# ===================================================================
# METABASE - Common Configuration
# ===================================================================
metabase.site-url=${METABASE_URL:https://treated-paste-eos-memo.trycloudflare.com}
metabase.secret-key=${METABASE_SECRET_KEY}
metabase.username=${METABASE_USERNAME:admin@example.com}
metabase.password=${METABASE_PASSWORD:password}
metabase.token-expiration-minutes=10


# Dashboards configuration
metabase.dashboards[0].id=5
metabase.dashboards[0].name=Dashboard Gerencial
metabase.dashboards[0].description=Metricas ejecutivas y KPIs principales
metabase.dashboards[0].allowed-roles=ROLE_ADMIN,ROLE_MANAGER, ROLE_GERENTE
metabase.dashboards[0].filters[0].name=user_id
metabase.dashboards[0].filters[0].type=USER_ATTRIBUTE
metabase.dashboards[0].filters[0].source=userId
metabase.dashboards[0].filters[1].name=department
metabase.dashboards[0].filters[1].type=USER_ATTRIBUTE
metabase.dashboards[0].filters[1].source=department

metabase.dashboards[1].id=3
metabase.dashboards[1].name=Dashboard Analitico Operacional
metabase.dashboards[1].description=Metricas historicas para analisis detallado
metabase.dashboards[1].allowed-roles=ROLE_USER,ROLE_ADMIN, ROLE_ANALISTA

# ===================================================================
# GEMINI AI - Common Configuration
# ===================================================================


# ===================================================================
# SPRINGDOC OPENAPI - Common Settings
# ===================================================================
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.api-docs.path=/v3/api-docs
springdoc.packagesToScan=com.cambiaso.ioc

springdoc.info.title=IOC Backend API
springdoc.info.version=1.0.0
springdoc.info.description=API para la plataforma de Inteligencia Operacional Cambiaso
springdoc.info.contact.name=Equipo de Desarrollo IOC
springdoc.info.contact.email=dev@cambiaso.com

# ===================================================================
# AI EXPLANATION - Common Settings
# ===================================================================
# PII Protection: if false, anonymize operator names before sending to Gemini
ai.explanation.send-pii=false
# Cache names for AI explanations with dynamic TTL
ai.explanation.cache-name-historical=aiExplanationsHistorical
ai.explanation.cache-name-current=aiExplanationsCurrent

# Gemini API Configuration
# API key must be set via environment variable: GEMINI_API_KEY
gemini.api-key=${GEMINI_API_KEY:}
gemini.model=gemini-2.5-flash
gemini.max-output-tokens=8192
# New: thinking budget default 0 (disabled). Set to -1 or positive number to enable.
gemini.thinking-budget=0
gemini.timeout.seconds=90
gemini.retry.max-attempts=2
gemini.retry.backoff.initial=500
gemini.retry.backoff.max=1500
gemini.base-url=https://generativelanguage.googleapis.com
